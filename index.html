<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é’“é±¼ä¹±æ–— - ç”Ÿæ€å¹³è¡¡ç‰ˆ</title>
    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-yellow: #FFD60A; 
            --ios-purple: #BF5AF2;
            --ios-red: #FF3B30;
            --ios-green: #34C759;
            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #021025;
            font-family: var(--font-stack);
            touch-action: none; user-select: none; -webkit-user-select: none;
        }

        #game-container {
            position: relative; width: 100vw; height: 100vh;
            background: #000; 
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* --- UI ç»„ä»¶ --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }

        .hud-header {
            position: absolute; top: 0; left: 0; width: 100%;
            box-sizing: border-box;
            display: flex; justify-content: space-between; 
            padding: max(15px, env(safe-area-inset-top)) 20px 0 20px;
        }

        .glass-pill {
            background: rgba(0, 0, 0, 0.4); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 6px 16px; border-radius: 30px;
            color: #fff; font-size: 15px; font-weight: 700;
            display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .center-btn {
            position: absolute; left: 50%; transform: translateX(-50%);
            top: max(15px, env(safe-area-inset-top));
            pointer-events: auto; cursor: pointer; transition: transform 0.1s;
        }
        .center-btn:active { transform: translateX(-50%) scale(0.95); background: rgba(255,255,255,0.2); }

        .leaderboard-box {
            position: absolute; left: 20px; 
            top: calc(max(15px, env(safe-area-inset-top)) + 50px);
            background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px);
            border-radius: 12px; padding: 8px 10px; width: 110px;
            border: 1px solid rgba(255,255,255,0.1); pointer-events: none;
        }
        .lb-title { 
            font-size: 10px; color: rgba(255,255,255,0.6); 
            text-transform: uppercase; margin-bottom: 4px; font-weight: 600; 
        }
        .lb-row { display: flex; justify-content: space-between; font-size: 11px; color: #fff; margin-bottom: 3px; }
        .lb-row.me { color: var(--ios-yellow); font-weight: 800; font-size: 12px; }
        
        .buff-indicator { 
            font-size: 10px; color: #66FF66; margin-top: 4px; 
            display: none; text-align: center; font-weight: bold;
            animation: pulse 1.5s infinite;
        }
        .buff-indicator.active { display: block; }
        @keyframes pulse { 0% {opacity:0.6;} 50% {opacity:1;} 100% {opacity:0.6;} }

        .level-badge {
            position: absolute; right: 20px; 
            top: calc(max(15px, env(safe-area-inset-top)) + 50px);
            background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 8px;
            font-size: 11px; color: #fff; font-weight: 600; backdrop-filter: blur(8px);
        }

        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            display: flex; align-items: center; justify-content: center;
            z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .ios-card {
            width: 85%; max-width: 360px;
            background: rgba(35, 35, 35, 0.95); border-radius: 28px;
            padding: 30px 20px; text-align: center;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 30px 80px rgba(0,0,0,0.6);
            transform: scale(0.95); transition: transform 0.3s;
            display: flex; flex-direction: column;
            max-height: 75vh;
        }
        .modal-overlay.active .ios-card { transform: scale(1); }

        .card-icon { font-size: 48px; margin-bottom: 10px; display: block; }
        .card-title { color: #fff; font-size: 22px; margin: 0 0 8px; font-weight: 800; }
        .card-text { color: #b0b0b0; font-size: 14px; line-height: 1.5; margin-bottom: 20px; }
        
        .btn {
            width: 100%; padding: 14px 0; border: none; border-radius: 16px;
            font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 5px;
        }
        .btn-primary { background: var(--ios-blue); color: #fff; }
        .btn-close { background: rgba(255,255,255,0.15); color: #fff; margin-top: 10px; padding: 10px 0; font-size: 14px; }
        .reset-link { margin-top: 15px; font-size: 12px; color: #666; text-decoration: underline; cursor: pointer; }

        .guide-container {
            flex: 1; overflow-y: auto; text-align: left;
            margin-bottom: 10px; border-radius: 12px;
            background: rgba(0,0,0,0.3); padding: 5px;
            scrollbar-width: none; -ms-overflow-style: none;
        }
        .guide-container::-webkit-scrollbar { display: none; }

        .guide-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .guide-left { display: flex; align-items: center; gap: 10px; }
        .guide-emoji { font-size: 22px; width: 30px; text-align: center; }
        .guide-score { color: #fff; font-weight: bold; font-size: 14px; }
        .guide-level { color: #666; font-size: 10px; text-align: right; }
        .guide-level.unlocked { color: var(--ios-green); }
        .guide-level.locked { color: var(--ios-red); }

        .t-trash { color: #888; }
        .t-fish { color: #fff; }
        .t-rare { color: var(--ios-purple); }
        .t-legendary { color: var(--ios-yellow); text-shadow: 0 0 5px rgba(255,214,10,0.5); }

    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="hud-header">
            <div class="glass-pill">
                <span>ğŸ¯</span>
                <span class="hud-value"><span id="score">0</span> / <span id="target">500</span></span>
            </div>
            <div class="glass-pill">
                <span>â³</span>
                <span class="hud-value"><span id="time" style="color:#fff">60</span>s</span>
            </div>
        </div>

        <div class="glass-pill center-btn" onclick="Game.showGuide()">
            <span>ğŸ“˜ æˆ˜åˆ©å“å›¾é‰´</span>
        </div>
        
        <div class="leaderboard-box">
            <div class="lb-title">Top 3</div>
            <div id="lb-list"></div>
            <div id="buff-msg" class="buff-indicator">âš¡ï¸ +20% Speed</div>
        </div>

        <div class="level-badge">
            Level <span id="level-display">1</span>
        </div>
    </div>

    <!-- å›¾é‰´å¼¹çª— -->
    <div id="guide-screen" class="modal-overlay">
        <div class="ios-card">
            <h1 class="card-title" style="font-size: 18px; margin-bottom: 10px;">æˆ˜åˆ©å“å…¨æ”¶é›† (54ç§)</h1>
            <p style="font-size:12px; color:#888; margin:0 0 10px 0;">å½“å‰å…³å¡: <span id="guide-curr-level" style="color:#fff">1</span> | æ¯2å…³è§£é”ä¸€ä¸ªæ–°ç‰©å“</p>
            <div id="guide-list" class="guide-container"></div>
            <button class="btn btn-close" onclick="Game.closeGuide()">å…³é—­</button>
        </div>
    </div>

    <!-- å¼€å§‹ç•Œé¢ -->
    <div id="start-screen" class="modal-overlay active">
        <div class="ios-card">
            <span class="card-icon">ğŸŒŠ</span>
            <h1 class="card-title">æ·±æµ·ä¹±æ–—</h1>
            <p class="card-text">
                <b>ç”Ÿæ€å¹³è¡¡ï¼š</b> é±¼ç±»å¤§å¹…å¢åŠ ï¼Œåƒåœ¾å‡å°‘ã€‚<br>
                <b>è§£é”æœºåˆ¶ï¼š</b> æŒ‘æˆ˜æ›´é«˜å…³å¡ï¼Œè§£é”æ›´ç¨€æœ‰çš„å®è—ï¼
            </p>
            <button id="start-btn" class="btn btn-primary" onclick="Game.startSavedLevel()">å¼€å§‹æ¸¸æˆ</button>
            <div class="reset-link" onclick="Game.resetProgress()">é‡ç½®è¿›åº¦ (Lv.1)</div>
        </div>
    </div>

    <!-- å¤±è´¥ -->
    <div id="fail-screen" class="modal-overlay">
        <div class="ios-card">
            <span class="card-icon">ğŸ¥€</span>
            <h1 class="card-title">æŒ‘æˆ˜å¤±è´¥</h1>
            <p class="card-text">åˆ†æ•°æ²¡è¾¾æ ‡...<br>æœ€ç»ˆå¾—åˆ†: <span id="fail-score" style="color:#fff; font-weight:bold">0</span></p>
            <button class="btn" style="background:#FF3B30; color:#fff" onclick="Game.retryLevel()">é‡è¯•</button>
        </div>
    </div>
    
    <!-- æˆåŠŸ -->
    <div id="win-screen" class="modal-overlay">
        <div class="ios-card">
            <span class="card-icon">ğŸ†</span>
            <h1 class="card-title">é€šå…³æˆåŠŸ</h1>
            <p class="card-text">è¿›åº¦å·²ä¿å­˜ï¼<br>æ–°æˆ˜åˆ©å“å¯èƒ½å·²ç»è§£é”äº†...</p>
            <button class="btn" style="background:#34C759; color:#fff" onclick="Game.nextLevel()">ä¸‹ä¸€å…³</button>
        </div>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let W, H;
function resize() {
    const dpr = window.devicePixelRatio || 1;
    W = window.innerWidth;
    H = window.innerHeight;
    canvas.width = W * dpr;
    canvas.height = H * dpr;
    ctx.scale(dpr, dpr);
}
window.addEventListener('resize', resize);
resize();

// --- 54ç§æˆ˜åˆ©å“ ---
const RAW_LOOT = [
    // --- åˆå§‹ Lv.1 (4ä¸ª) ---
    { emoji: 'ğŸ‘¢', score: 10,   weight: 5.0, speed: 0.5, radius: 24, type: 'trash' },
    { emoji: 'ğŸ¥«', score: 15,   weight: 4.5, speed: 0.4, radius: 20, type: 'trash' },
    { emoji: 'ğŸŸ', score: 200,  weight: 2.0, speed: 1.5, radius: 22, type: 'fish' },
    { emoji: 'ğŸ¡', score: 150,  weight: 3.5, speed: 0.8, radius: 28, type: 'fish' },
    // --- æ¯2å…³è§£é”1ä¸ª ---
    { emoji: 'ğŸ§±', score: 5,    weight: 8.0, speed: 0.2, radius: 26, type: 'trash' }, // Lv3
    { emoji: 'ğŸ¦´', score: 8,    weight: 4.0, speed: 0.5, radius: 18, type: 'trash' }, // Lv5
    { emoji: 'ğŸ§¦', score: 5,    weight: 3.0, speed: 0.6, radius: 16, type: 'trash' },
    { emoji: 'ğŸ’©', score: 1,    weight: 6.0, speed: 0.3, radius: 22, type: 'trash' },
    { emoji: 'ğŸ ', score: 400,  weight: 1.5, speed: 2.5, radius: 18, type: 'fish' },
    { emoji: 'ğŸŒ¿', score: 2,    weight: 2.0, speed: 0.5, radius: 20, type: 'trash' },
    { emoji: 'ğŸ¦‘', score: 350,  weight: 1.5, speed: 2.2, radius: 20, type: 'fish' },
    { emoji: 'ğŸ¦€', score: 450,  weight: 4.0, speed: 0.6, radius: 25, type: 'fish' },
    { emoji: 'ğŸ¦', score: 500,  weight: 1.0, speed: 3.0, radius: 14, type: 'fish' },
    { emoji: 'ğŸš', score: 300,  weight: 5.0, speed: 0.1, radius: 15, type: 'fish' },
    { emoji: 'ğŸ¸', score: 600,  weight: 1.2, speed: 2.8, radius: 18, type: 'fish' },
    { emoji: 'ğŸª¼', score: 550,  weight: 2.0, speed: 1.0, radius: 22, type: 'fish' },
    { emoji: 'ğŸ¦†', score: 700,  weight: 2.5, speed: 2.5, radius: 24, type: 'fish' },
    { emoji: 'âš“', score: 100,  weight: 10.0, speed: 0.1, radius: 30, type: 'trash' }, 
    { emoji: 'ğŸ¾', score: 50,   weight: 3.0, speed: 1.0, radius: 15, type: 'trash' },
    { emoji: 'ğŸ¢', score: 1000, weight: 6.0, speed: 0.4, radius: 36, type: 'fish' }, 
    { emoji: 'ğŸ“±', score: 1200, weight: 0.8, speed: 2.5, radius: 15, type: 'rare' },
    { emoji: 'ğŸ¦', score: 1100, weight: 3.5, speed: 1.5, radius: 26, type: 'fish' },
    { emoji: 'ğŸ“·', score: 1500, weight: 1.5, speed: 2.0, radius: 20, type: 'rare' },
    { emoji: 'ğŸ™', score: 1300, weight: 4.0, speed: 1.2, radius: 30, type: 'fish' },
    { emoji: 'âŒš', score: 1800, weight: 0.5, speed: 3.0, radius: 12, type: 'rare' },
    { emoji: 'ğŸ¦ˆ', score: 2000, weight: 5.0, speed: 3.5, radius: 40, type: 'fish' },
    { emoji: 'ğŸ”‘', score: 800,  weight: 0.2, speed: 3.0, radius: 10, type: 'rare' },
    { emoji: 'ğŸ¬', score: 2200, weight: 2.5, speed: 4.0, radius: 32, type: 'fish' },
    { emoji: 'ğŸ’', score: 2500, weight: 0.1, speed: 4.0, radius: 8,  type: 'rare' },
    { emoji: 'ğŸ³', score: 3000, weight: 8.0, speed: 1.0, radius: 50, type: 'fish' },
    { emoji: 'ğŸ‘›', score: 1600, weight: 1.0, speed: 2.0, radius: 18, type: 'rare' },
    { emoji: 'ğŸ’³', score: 1400, weight: 0.1, speed: 3.5, radius: 12, type: 'rare' },
    { emoji: 'ğŸ’»', score: 2000, weight: 3.0, speed: 1.0, radius: 28, type: 'rare' },
    { emoji: 'ğŸš', score: 2800, weight: 2.0, speed: 5.0, radius: 22, type: 'rare' },
    { emoji: 'ğŸ’°', score: 3000, weight: 2.0, speed: 3.0, radius: 20, type: 'legendary' }, 
    { emoji: 'ğŸ“º', score: 2500, weight: 2.5, speed: 1.5, radius: 28, type: 'rare' },
    { emoji: 'ğŸš—', score: 3500, weight: 8.0, speed: 4.0, radius: 35, type: 'legendary' },
    { emoji: 'ğŸ’', score: 4000, weight: 0.5, speed: 4.5, radius: 14, type: 'legendary' },
    { emoji: 'ğŸ‘‘', score: 4500, weight: 1.0, speed: 2.0, radius: 20, type: 'legendary' },
    { emoji: 'ğŸ†', score: 3800, weight: 2.0, speed: 1.0, radius: 25, type: 'legendary' },
    { emoji: 'ğŸš€', score: 5000, weight: 3.0, speed: 8.0, radius: 30, type: 'legendary' },
    { emoji: 'ğŸ›¸', score: 5500, weight: 1.5, speed: 6.0, radius: 25, type: 'legendary' },
    { emoji: 'ğŸŒ¹', score: 6000, weight: 0.1, speed: 5.0, radius: 12, type: 'legendary' },
    { emoji: 'ğŸ‘½', score: 6666, weight: 0.5, speed: 7.0, radius: 16, type: 'legendary' },
    { emoji: 'ğŸ‘»', score: 4444, weight: 0.0, speed: 3.0, radius: 20, type: 'legendary' },
    { emoji: 'ğŸ¤–', score: 5000, weight: 5.0, speed: 2.0, radius: 28, type: 'legendary' },
    { emoji: 'ğŸ«€', score: 8888, weight: 0.3, speed: 6.0, radius: 14, type: 'legendary' },
    { emoji: 'â¤ï¸', score: 7777, weight: 0.2, speed: 4.0, radius: 18, type: 'legendary' },
    { emoji: 'ğŸ—¿', score: 5000, weight: 15.0, speed: 0.1, radius: 40, type: 'legendary' },
    { emoji: 'ğŸ¦–', score: 9000, weight: 10.0, speed: 5.0, radius: 50, type: 'legendary' },
    { emoji: 'ğŸŒš', score: 9500, weight: 8.0, speed: 1.5, radius: 45, type: 'legendary' },
    { emoji: 'ğŸŒŸ', score: 8000, weight: 0.1, speed: 10.0, radius: 15, type: 'legendary' },
    { emoji: 'ğŸŒ', score: 9999, weight: 12.0, speed: 0.5, radius: 60, type: 'legendary' },
    { emoji: 'ğŸ‘‘', score: 10000, weight: 1.0, speed: 5.0, radius: 20, type: 'legendary' },
];

// æ„å»ºæ•°æ®åº“
const LOOT_DB = RAW_LOOT.map((item, index) => {
    let lvl = 1;
    if (index >= 4) {
        lvl = 3 + (index - 4) * 2;
    }
    
    // --- æ ¸å¿ƒä¼˜åŒ–ï¼šæƒé‡æ§åˆ¶ (å‡å°‘åƒåœ¾ï¼Œå¢åŠ é±¼) ---
    // åŸºç¡€åƒåœ¾æƒé‡é™ä¸º 15
    let rWeight = 15;
    // é±¼ç±»æƒé‡æå‡è‡³ 60
    if (item.type === 'fish') rWeight = 60;
    // ç¨€æœ‰ç‰©å“é€‚ä¸­
    if (item.type === 'rare') rWeight = 15;
    // ä¼ è¯´ç‰©å“æä½
    if (item.type === 'legendary') rWeight = 4;
    
    // éšç€ç´¢å¼•å¢åŠ ï¼Œæƒé‡å¾®è°ƒé™ä½ï¼Œé˜²æ­¢åæœŸå›¾é‰´æ±¡æŸ“
    rWeight = Math.max(1, rWeight - (index * 0.1));

    return { ...item, minLevel: lvl, rarityWeight: rWeight };
});

const CONFIG = {
    baseHookSpeed: 14,
    swingSpeed: 0.025,
};

// --- èƒŒæ™¯ç»˜åˆ¶ ---
const Ocean = {
    offset: 0,
    draw() {
        this.offset += 0.015;
        let grad = ctx.createLinearGradient(0, 0, 0, H);
        grad.addColorStop(0, "#84fab0"); 
        grad.addColorStop(0.4, "#8fd3f4");
        grad.addColorStop(1, "#002050");
        
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, W, H);

        this.drawWave(120, 0.008, 10, "rgba(255, 255, 255, 0.15)");
        this.drawWave(180, 0.012, 15, "rgba(255, 255, 255, 0.1)");
        this.drawWave(240, 0.006, 8, "rgba(255, 255, 255, 0.05)");
    },
    drawWave(yBase, freq, amp, color) {
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.moveTo(0, H);
        for (let i = 0; i <= W; i += 10) {
            let y = yBase + Math.sin(i * freq + this.offset) * amp;
            ctx.lineTo(i, y + i * 0.05); 
        }
        ctx.lineTo(W, H);
        ctx.lineTo(0, H);
        ctx.fill();
    }
};

class Angler {
    constructor(id, totalCount, isPlayer) {
        this.id = id;
        this.isPlayer = isPlayer;
        this.score = 0; 
        
        const rowSize = 5;
        const totalRows = Math.ceil(totalCount / rowSize);
        this.row = Math.floor(id / rowSize);
        this.col = id % rowSize;
        this.countInThisRow = (this.row === totalRows - 1) ? (totalCount - (this.row * rowSize)) : rowSize;
        
        this.baseTop = 220; 
        this.rowHeight = 70;
        this.y = this.baseTop + this.row * this.rowHeight; 
        this.x = 0; 

        this.color = this.isPlayer ? '#FFD700' : '#888';
        this.angle = Math.PI/2;
        this.swingDir = Math.random() > 0.5 ? 1 : -1;
        this.state = 0; 
        this.lineLen = 20;
        this.maxLen = H * 1.3;
        this.caughtItem = null;
        let aiBase = Math.max(10, 80 - Game.level * 0.8); 
        this.aiTimer = Math.random() * aiBase + 20;
    }

    update() {
        const maxLayoutWidth = Math.min(W, 600); 
        const offsetLeft = (W - maxLayoutWidth) / 2;
        this.x = offsetLeft + (maxLayoutWidth / (this.countInThisRow + 1)) * (this.col + 1);

        if (this.state === 0) {
            const limit = 0.65;
            if (this.angle > Math.PI - limit) this.swingDir = -1;
            if (this.angle < limit) this.swingDir = 1;
            this.angle += CONFIG.swingSpeed * this.swingDir;
            
            if (!this.isPlayer) {
                this.aiTimer--;
                if (this.aiTimer <= 0) {
                    this.shoot();
                    let aiBase = Math.max(10, 80 - Game.level * 0.8);
                    this.aiTimer = Math.random() * aiBase + 20;
                }
            }
        }
        else if (this.state === 1) {
            this.lineLen += CONFIG.baseHookSpeed;
            const tx = this.x + Math.cos(this.angle) * this.lineLen;
            const ty = this.y + Math.sin(this.angle) * this.lineLen;
            
            if (this.lineLen >= this.maxLen || tx<0 || tx>W) {
                this.state = 3; this.waitTimer = 10;
            } else {
                for (let item of Game.items) {
                    if (!item.caught && Math.hypot(tx-item.x, ty-item.y) < item.radius + 5) {
                        item.caught = true;
                        this.caughtItem = item;
                        this.state = 2;
                        if(this.isPlayer) {
                            let isHighValue = item.score >= 1000;
                            Game.addEffect(tx, ty, isHighValue ? "Wow!" : "Hit!", isHighValue ? "#FFD700" : "#fff");
                        }
                        break;
                    }
                }
            }
        }
        else if (this.state === 3) {
            this.waitTimer--;
            if (this.waitTimer<=0) this.state = 2;
        }
        else if (this.state === 2) {
            let speedMult = 1.0;
            if (Game.leaderId === this.id) speedMult = 1.2;
            
            let speed = (CONFIG.baseHookSpeed * 1.5 * speedMult);
            if (this.caughtItem) {
                speed = (CONFIG.baseHookSpeed / this.caughtItem.weight) * speedMult;
            }
            
            this.lineLen -= speed;
            if(this.caughtItem) {
                this.caughtItem.x = this.x + Math.cos(this.angle) * this.lineLen;
                this.caughtItem.y = this.y + Math.sin(this.angle) * this.lineLen;
            }
            
            if (this.lineLen <= 20) {
                this.lineLen = 20;
                this.state = 0;
                if (this.caughtItem) {
                    this.score += this.caughtItem.score;
                    if (this.isPlayer) {
                        Game.playerScore = this.score;
                        let isLegend = this.caughtItem.type === 'legendary';
                        Game.addEffect(this.x, this.y-50, `+${this.caughtItem.score}`, isLegend ? "#FFD700" : "#fff", isLegend?1.5:1);
                    }
                    Game.items = Game.items.filter(i => i !== this.caughtItem);
                    this.caughtItem = null;
                }
            }
        }
    }

    shoot() { if (this.state === 0) this.state = 1; }

    draw() {
        const tx = this.x + Math.cos(this.angle) * this.lineLen;
        const ty = this.y + Math.sin(this.angle) * this.lineLen;
        
        ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(tx, ty);
        ctx.strokeStyle = this.isPlayer ? 'rgba(255, 255, 255, 0.95)' : 'rgba(255, 255, 255, 0.4)';
        ctx.lineWidth = this.isPlayer ? 2 : 1;
        ctx.stroke();
        
        ctx.beginPath(); ctx.arc(tx, ty, 5, 0, Math.PI*2);
        ctx.fillStyle = this.isPlayer ? '#FF3B30' : '#ccc'; ctx.fill();
        
        ctx.font = "24px Apple Color Emoji, Segoe UI Emoji"; 
        ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillText(this.isPlayer?"ğŸ¤ ":"ğŸ¤–", this.x, this.y-22);
        
        if (Game.leaderId === this.id) {
            ctx.font = "18px sans-serif";
            ctx.fillText("ğŸ‘‘", this.x, this.y - 48);
        }

        if (this.isPlayer) {
            ctx.fillStyle="#34C759"; ctx.beginPath();
            ctx.moveTo(this.x, this.y-55); ctx.lineTo(this.x-6, this.y-65); ctx.lineTo(this.x+6, this.y-65);
            ctx.fill();
        }
    }
}

class Item {
    constructor() {
        // --- æ ¸å¿ƒç”Ÿæˆé€»è¾‘ ---
        let availablePool = LOOT_DB.filter(i => Game.level >= i.minLevel);
        
        // æ–°ç‰©å“æ¦‚ç‡Buff
        let newlyUnlocked = availablePool.filter(i => i.minLevel === Game.level);
        let totalWeight = availablePool.reduce((sum, item) => sum + item.rarityWeight, 0);
        
        if (newlyUnlocked.length > 0) totalWeight += 50; 

        let random = Math.random() * totalWeight;
        let selected = availablePool[0];

        if (newlyUnlocked.length > 0 && random > (totalWeight - 50)) {
            selected = newlyUnlocked[0];
        } else {
            for (let item of availablePool) {
                if (random < item.rarityWeight) { selected = item; break; }
                random -= item.rarityWeight;
            }
        }

        Object.assign(this, selected);
        this.speed *= (1 + Math.min(0.5, Game.level * 0.01)); 

        const rows = Math.ceil(Game.totalAnglers/5);
        const lastAnglerY = 220 + (rows - 1) * 70; 
        const safeTop = lastAnglerY + 60;

        this.y = safeTop + Math.random() * (H - safeTop - 40);
        this.dir = Math.random() > 0.5 ? 1 : -1;
        this.x = this.dir === 1 ? -60 : W + 60;
        this.caught = false;
        this.animOffset = Math.random() * 100;
    }
    
    update() {
        if (!this.caught) this.x += this.speed * this.dir;
        return (this.dir===1 && this.x<W+70) || (this.dir===-1 && this.x>-70);
    }
    
    draw() {
        ctx.save(); ctx.translate(this.x, this.y);
        if(this.dir===-1 && !this.caught) ctx.scale(-1, 1);
        if(this.caught) ctx.rotate(Math.sin(Game.frameCount*0.3)*0.5);
        
        const pulse = 10 + Math.sin((Game.frameCount + this.animOffset) * 0.1) * 4;
        
        ctx.shadowColor = "rgba(255, 255, 255, 1)";
        ctx.shadowBlur = pulse; 
        
        ctx.font = `${this.radius*2.2}px Apple Color Emoji, Segoe UI Emoji`; 
        ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillText(this.emoji, 0, 0);
        
        if (this.type === 'legendary' && !this.caught) {
            ctx.shadowColor = "rgba(255, 220, 0, 1)";
            ctx.shadowBlur = pulse + 10;
            ctx.globalCompositeOperation = 'source-over'; 
            ctx.fillText(this.emoji, 0, 0); 
        }
        ctx.restore();
    }
}

const Game = {
    level: 1, maxLevel: 1, 
    playerScore: 0, target: 0, timeLeft: 60, totalAnglers: 1, leaderId: -1,
    anglers: [], items: [], effects: [], isPlaying: false, timerId: null, loopId: null, frameCount: 0,

    init() {
        const saved = localStorage.getItem('fishing_max_level');
        if (saved) { this.maxLevel = parseInt(saved); }
        document.getElementById('start-btn').innerText = `ç»§ç»­ç¬¬ ${this.maxLevel} å…³`;
    },

    showGuide() {
        document.getElementById('guide-curr-level').innerText = this.maxLevel;
        let html = '';
        LOOT_DB.forEach(item => {
            let className = `t-${item.type}`;
            let lockedClass = this.maxLevel >= item.minLevel ? 'unlocked' : 'locked';
            let lockText = this.maxLevel >= item.minLevel ? 'å·²è§£é”' : `Lv.${item.minLevel}`;
            let emojiDisplay = this.maxLevel >= item.minLevel ? item.emoji : 'ğŸ”’';
            
            html += `
                <div class="guide-row">
                    <div class="guide-left">
                        <div class="guide-emoji">${emojiDisplay}</div>
                        <span class="guide-score ${className}">${item.score}</span>
                    </div>
                    <span class="guide-level ${lockedClass}">${lockText}</span>
                </div>
            `;
        });
        document.getElementById('guide-list').innerHTML = html;
        this.showModal('guide-screen');
    },

    closeGuide() {
        if (this.isPlaying) {
            document.getElementById('guide-screen').classList.remove('active');
        } else {
            this.showModal('start-screen');
        }
    },

    saveProgress(newLevel) {
        if (newLevel > this.maxLevel) {
            this.maxLevel = newLevel;
            localStorage.setItem('fishing_max_level', this.maxLevel);
        }
    },

    resetProgress() {
        if(confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è¿›åº¦å—ï¼Ÿ')) {
            localStorage.removeItem('fishing_max_level');
            this.maxLevel = 1;
            document.getElementById('start-btn').innerText = `å¼€å§‹ç¬¬ 1 å…³`;
            alert('è¿›åº¦å·²é‡ç½®');
        }
    },

    startSavedLevel() { this.startLevel(this.maxLevel); },

    getBotCount(lvl) {
        let count = 1 + Math.floor(lvl / 5.5); 
        return Math.min(19, count);
    },
    getTargetScore(lvl) { return 500 + (lvl * 250); },
    showModal(id) {
        document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
        if(id) document.getElementById(id).classList.add('active');
    },

    startLevel(lvl) {
        this.level = lvl;
        this.playerScore = 0;
        this.timeLeft = 60;
        this.target = this.getTargetScore(lvl);
        let botCount = this.getBotCount(lvl);
        this.totalAnglers = botCount + 1; 

        this.showModal(null);
        document.getElementById('level-display').innerText = lvl;
        this.initEntities();
        this.isPlaying = true;
        
        clearInterval(this.timerId);
        this.timerId = setInterval(() => {
            if(!this.isPlaying) return;
            this.timeLeft--;
            const timeEl = document.getElementById('time');
            timeEl.innerText = this.timeLeft;
            timeEl.style.color = this.timeLeft <= 10 ? '#FF3B30' : '#fff';
            if (this.timeLeft <= 0) this.checkResult();
        }, 1000);
        
        cancelAnimationFrame(this.loopId);
        this.loop();
    },

    initEntities() {
        this.anglers = [];
        this.items = [];
        this.effects = [];
        let playerIdx = Math.floor(this.totalAnglers / 2);
        for (let i = 0; i < this.totalAnglers; i++) {
            this.anglers.push(new Angler(i, this.totalAnglers, i === playerIdx));
        }
        for(let i=0; i<8; i++) this.items.push(new Item());
    },

    updateLeaderboard() {
        if (this.frameCount % 10 === 0) {
            let sorted = [...this.anglers].sort((a,b) => b.score - a.score);
            this.leaderId = sorted[0].id;
            let html = '';
            for(let i=0; i<Math.min(3, sorted.length); i++) {
                let ag = sorted[i];
                let name = ag.isPlayer ? "æˆ‘" : `Bot ${ag.id}`;
                let rowClass = ag.isPlayer ? "lb-row me" : "lb-row";
                html += `<div class="${rowClass}"><span>${i+1}.${name}</span><span>${ag.score}</span></div>`;
            }
            document.getElementById('lb-list').innerHTML = html;
            const buffEl = document.getElementById('buff-msg');
            if (sorted[0].isPlayer) buffEl.classList.add('active');
            else buffEl.classList.remove('active');
        }
    },

    retryLevel() { this.startLevel(this.level); },
    nextLevel() { this.startLevel(this.level + 1); },

    checkResult() {
        this.isPlaying = false;
        clearInterval(this.timerId);
        if (this.playerScore >= this.target) {
            this.saveProgress(this.level + 1);
            this.showModal('win-screen');
        } else {
            document.getElementById('fail-score').innerText = this.playerScore;
            this.showModal('fail-screen');
        }
    },

    addEffect(x, y, text, color="#fff", scale=1) {
        this.effects.push({x, y, text, color, scale, life: 60});
    },

    loop() {
        if (!this.isPlaying) return;
        ctx.clearRect(0,0,W,H);
        this.frameCount++;

        Ocean.draw();

        document.getElementById('score').innerText = this.playerScore;
        document.getElementById('target').innerText = this.target;
        this.updateLeaderboard();
        let spawnRate = Math.max(10, 60 - (this.totalAnglers * 1.5)); 
        if (this.frameCount % Math.floor(spawnRate) === 0) {
            if (this.items.length < 30) this.items.push(new Item());
        }

        this.items = this.items.filter(i => {
            if (i.caught) return true;
            return i.update();
        });

        this.anglers.forEach(a => a.update());
        let sortedAnglers = [...this.anglers].sort((a,b) => a.y - b.y);

        sortedAnglers.forEach(a => { a.draw(); });
        this.items.forEach(i => { if(!i.caught) i.draw(); });
        sortedAnglers.forEach(a => { if(a.caughtItem) a.caughtItem.draw(); });

        this.effects = this.effects.filter(e => e.life>0);
        this.effects.forEach(e => {
            e.y -= 1.0; e.life--;
            ctx.save();
            ctx.translate(e.x, e.y);
            let s = e.scale * (1 + Math.sin(e.life * 0.2) * 0.1);
            ctx.scale(s, s);
            ctx.fillStyle = e.color;
            ctx.globalAlpha = Math.min(1, e.life/30);
            ctx.font = "800 24px var(--font-stack)";
            ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 4;
            ctx.fillText(e.text, 0, 0);
            ctx.restore();
        });

        this.loopId = requestAnimationFrame(() => this.loop());
    }
};

Game.init();

function handleInput(e) {
    if (!Game.isPlaying) return;
    if (e.target.closest('.glass-pill') || e.target.tagName === 'BUTTON') return;
    
    e.preventDefault();
    const player = Game.anglers.find(a => a.isPlayer);
    if (player) player.shoot();
}
canvas.addEventListener('pointerdown', handleInput);

</script>
</body>
</html>
