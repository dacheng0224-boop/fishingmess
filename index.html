<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Fishing Brawl - Layout Optimized</title>
    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-yellow: #FFD60A; 
            --ios-purple: #BF5AF2;
            --ios-red: #FF3B30;
            --ios-green: #34C759;
            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #021025;
            font-family: var(--font-stack);
            touch-action: none; user-select: none; -webkit-user-select: none;
        }

        #game-container { position: relative; width: 100vw; height: 100vh; background: #000; }
        canvas { display: block; width: 100%; height: 100%; }

        /* --- UI ç»„ä»¶ --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
            display: flex; flex-direction: column;
        }

        /* --- é¡¶éƒ¨å•è¡Œå¸ƒå±€æ ¸å¿ƒ --- */
        .hud-header {
            width: 100%; box-sizing: border-box;
            /* å…³é”®ï¼šå•è¡Œæ’åˆ—ï¼Œå‚ç›´å±…ä¸­ï¼Œä¸¤ç«¯å¯¹é½ */
            display: flex; align-items: center; justify-content: space-between;
            padding: max(10px, env(safe-area-inset-top)) 12px 0 12px;
            pointer-events: none; 
            gap: 8px; /* ç»„ä»¶é—´è· */
        }

        /* é€šç”¨èƒ¶å›Šæ ·å¼ (ç”¨äºæ—¶é—´å’Œåˆ†æ•°) */
        .glass-pill {
            background: rgba(0, 0, 0, 0.4); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0 12px; height: 36px; border-radius: 18px;
            color: #fff; font-size: 13px; font-weight: 700;
            display: flex; align-items: center; justify-content: center; gap: 4px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            white-space: nowrap;
        }

        /* 1. åœ†å½¢å…³å¡æ ‡è¯† (å¼±åŒ–) */
        .circle-badge {
            width: 36px; height: 36px; min-width: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 14px; font-weight: 800;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* 2. å€’è®¡æ—¶ (ç´§å‡‘) */
        .time-pill {
            min-width: 60px;
        }

        /* 3. ç§¯åˆ†è¿›åº¦ (æ ¸å¿ƒï¼Œå æ®å‰©ä½™ç©ºé—´) */
        .score-pill {
            flex: 1; /* è‡ªåŠ¨æ‹‰ä¼¸ */
            background: rgba(0, 0, 0, 0.5); /* ç¨å¾®æ·±ä¸€ç‚¹å¼ºè°ƒ */
            max-width: 200px; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢åœ¨å¤§å±å¤ªé•¿ */
        }

        /* 4. åœ†å½¢å›¾é‰´æŒ‰é’® (å¼±åŒ–å…¥å£) */
        .guide-btn {
            width: 36px; height: 36px; min-width: 36px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; cursor: pointer; pointer-events: auto;
            transition: transform 0.1s;
        }
        .guide-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }

        /* 5. è¯­è¨€åˆ‡æ¢ (ç´§å‡‘) */
        #lang-select {
            height: 36px;
            background: rgba(0, 0, 0, 0.4); color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 18px; padding: 0 8px;
            font-size: 12px; outline: none; text-align: center;
            backdrop-filter: blur(10px); pointer-events: auto;
            cursor: pointer;
        }

        /* æ’è¡Œæ¦œä½ç½®å¾®è°ƒ */
        .leaderboard-box {
            position: absolute; left: 12px; top: 70px; /* ç´§è´´é¡¶éƒ¨æ ä¸‹æ–¹ */
            background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px);
            border-radius: 12px; padding: 8px 10px; width: 110px;
            border: 1px solid rgba(255,255,255,0.1); pointer-events: none;
        }
        .lb-title { font-size: 10px; color: rgba(255,255,255,0.6); text-transform: uppercase; margin-bottom: 4px; font-weight: 600; }
        .lb-row { display: flex; justify-content: space-between; font-size: 11px; color: #fff; margin-bottom: 3px; }
        .lb-row.me { color: var(--ios-yellow); font-weight: 800; font-size: 12px; }
        
        .buff-indicator { 
            font-size: 10px; color: #66FF66; margin-top: 4px; display: none; text-align: center; font-weight: bold;
            animation: pulse 1.5s infinite;
        }
        .buff-indicator.active { display: block; }
        @keyframes pulse { 0% {opacity:0.6;} 50% {opacity:1;} 100% {opacity:0.6;} }

        /* å¼¹çª—é€šç”¨æ ·å¼ */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(12px);
            display: flex; align-items: center; justify-content: center;
            z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .ios-card {
            width: 85%; max-width: 360px;
            background: rgba(35, 35, 35, 0.95); border-radius: 28px;
            padding: 30px 20px; text-align: center;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 30px 80px rgba(0,0,0,0.6);
            transform: scale(0.95); transition: transform 0.3s;
            display: flex; flex-direction: column; max-height: 75vh;
        }
        .modal-overlay.active .ios-card { transform: scale(1); }

        .card-icon { font-size: 48px; margin-bottom: 10px; display: block; }
        .card-title { color: #fff; font-size: 22px; margin: 0 0 8px; font-weight: 800; }
        .card-text { color: #b0b0b0; font-size: 14px; line-height: 1.5; margin-bottom: 20px; }
        
        .btn { width: 100%; padding: 14px 0; border: none; border-radius: 16px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 5px; }
        .btn-primary { background: var(--ios-blue); color: #fff; }
        .btn-close { background: rgba(255,255,255,0.15); color: #fff; margin-top: 10px; padding: 10px 0; font-size: 14px; }
        .reset-link { margin-top: 15px; font-size: 12px; color: #666; text-decoration: underline; cursor: pointer; }

        /* å›¾é‰´åˆ—è¡¨ */
        .guide-container { 
            flex: 1; overflow-y: auto; text-align: left; margin-bottom: 10px; 
            border-radius: 12px; background: rgba(0,0,0,0.3); padding: 5px; scrollbar-width: none; 
        }
        .guide-container::-webkit-scrollbar { display: none; }
        .guide-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .guide-left { display: flex; align-items: center; gap: 10px; }
        .guide-emoji { font-size: 22px; width: 30px; text-align: center; }
        .guide-score { color: #fff; font-weight: bold; font-size: 14px; }
        .guide-level { color: #666; font-size: 10px; text-align: right; }
        .guide-level.unlocked { color: var(--ios-green); }
        
        .rtl-mode { direction: rtl; text-align: right; }
        .rtl-mode .guide-left { flex-direction: row; } 
        .rtl-mode .guide-level { text-align: left; }

        .t-trash { color: #888; }
        .t-fish { color: #fff; }
        .t-rare { color: var(--ios-purple); }
        .t-legendary { color: var(--ios-yellow); text-shadow: 0 0 5px rgba(255,214,10,0.5); }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <!-- é¡¶éƒ¨å•è¡Œå¸ƒå±€ -->
        <div class="hud-header">
            <!-- 1. å…³å¡æ ‡è¯† (åœ†å½¢) -->
            <div class="circle-badge" title="Current Level">
                <span id="level-display">1</span>
            </div>

            <!-- 2. å€’è®¡æ—¶ (èƒ¶å›Š) -->
            <div class="glass-pill time-pill">
                <span>â³</span><span id="time" style="color:#fff">60</span>
            </div>

            <!-- 3. ç§¯åˆ†è¿›åº¦ (å¼¹æ€§èƒ¶å›Š) -->
            <div class="glass-pill score-pill">
                <span>ğŸ¯</span>
                <span class="hud-value">
                    <span id="score">0</span> / <span id="target">500</span>
                </span>
            </div>

            <!-- 4. å›¾é‰´å…¥å£ (åœ†å½¢æŒ‰é’®) -->
            <div class="guide-btn" onclick="Game.showGuide()" title="Loot Guide">
                <span>ğŸ“˜</span>
            </div>

            <!-- 5. è¯­è¨€åˆ‡æ¢ -->
            <select id="lang-select" onchange="Game.setLanguage(this.value)">
                <option value="en">EN</option>
                <option value="ar">AR</option>
                <option value="id">ID</option>
                <option value="tr">TR</option>
            </select>
        </div>
        
        <!-- æ’è¡Œæ¦œ -->
        <div class="leaderboard-box">
            <div class="lb-title" id="ui-lb-title">Top 3</div>
            <div id="lb-list"></div>
            <div id="buff-msg" class="buff-indicator">âš¡ï¸ +20% Speed</div>
        </div>
    </div>

    <!-- å›¾é‰´å¼¹çª— -->
    <div id="guide-screen" class="modal-overlay">
        <div class="ios-card">
            <h1 class="card-title" id="guide-title">Loot Collection</h1>
            <p style="font-size:12px; color:#888; margin:0 0 10px 0;">
                <span id="guide-subtitle">Current Level:</span> <span id="guide-curr-level" style="color:#fff">1</span>
            </p>
            <div id="guide-list" class="guide-container"></div>
            <button class="btn btn-close" onclick="Game.closeGuide()" id="guide-close-btn">Close</button>
        </div>
    </div>

    <!-- å¼€å§‹ç•Œé¢ -->
    <div id="start-screen" class="modal-overlay active">
        <div class="ios-card">
            <span class="card-icon">ğŸŒŠ</span>
            <h1 class="card-title" id="start-title">Fishing Brawl</h1>
            <p class="card-text">
                <span id="start-text-1">Welcome back!</span><br>
                <span id="start-text-2">Progress saved automatically.</span>
            </p>
            <button id="start-btn" class="btn btn-primary" onclick="Game.startSavedLevel()">Start Game</button>
            <div class="reset-link" onclick="Game.resetProgress()" id="reset-btn">Reset Progress</div>
        </div>
    </div>

    <!-- å¤±è´¥ -->
    <div id="fail-screen" class="modal-overlay">
        <div class="ios-card">
            <span class="card-icon">ğŸ¥€</span>
            <h1 class="card-title" id="fail-title">Failed</h1>
            <p class="card-text">
                <span id="fail-text">Score not met...</span><br>
                <span id="fail-score-label">Score:</span> <span id="fail-score" style="color:#fff; font-weight:bold">0</span>
            </p>
            <button class="btn" style="background:#FF3B30; color:#fff" onclick="Game.retryLevel()" id="fail-btn">Retry</button>
        </div>
    </div>
    
    <!-- æˆåŠŸ -->
    <div id="win-screen" class="modal-overlay">
        <div class="ios-card">
            <span class="card-icon">ğŸ†</span>
            <h1 class="card-title" id="win-title">Success!</h1>
            <p class="card-text" id="win-text">Level Complete!<br>Get ready for next challenge.</p>
            <button class="btn" style="background:#34C759; color:#fff" onclick="Game.nextLevel()" id="win-btn">Next Level</button>
        </div>
    </div>
</div>

<script>
const IMAGES = { player: new Image(), bot: new Image() };
IMAGES.player.src = 'https://cos-cdn.kk6277.com/feishu/img_v3_02ub_a76a6e8e-98b8-40a0-aa3b-701048eb5b9g.png';
IMAGES.bot.src = 'https://cos-cdn.kk6277.com/feishu/img_v3_02ub_03b621f8-36a4-4ee9-8a2c-430c97cdd3ag.png';

const TRANSLATIONS = {
    en: {
        lb_title: "Top 3", buff_msg: "âš¡ï¸ +20% Speed",
        guide_title: "Loot Collection", guide_subtitle: "Current Level:", guide_close: "Close",
        start_title: "Fishing Brawl", start_t1: "Welcome back!", start_t2: "Difficulty increases with level.",
        start_btn_prefix: "Start Level", reset_btn: "Reset Progress (Lv.1)",
        fail_title: "Failed", fail_text: "Target score not reached...", fail_label: "Final Score:", fail_btn: "Retry",
        win_title: "Success!", win_text: "Level Complete! Progress saved.", win_btn: "Next Level",
        you: "YOU", bot: "Bot", unlocked: "Unlocked", locked_prefix: "Unlock Lv."
    },
    ar: {
        lb_title: "Ø£ÙØ¶Ù„ 3", buff_msg: "âš¡ï¸ +20% Ø³Ø±Ø¹Ø©",
        guide_title: "Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„ØºÙ†Ø§Ø¦Ù…", guide_subtitle: "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ:", guide_close: "Ø¥ØºÙ„Ø§Ù‚",
        start_title: "ØµØ±Ø§Ø¹ Ø§Ù„ØµÙŠØ¯", start_t1: "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹!", start_t2: "ØªØ²Ø¯Ø§Ø¯ Ø§Ù„ØµØ¹ÙˆØ¨Ø© Ù…Ø¹ Ø§Ù„Ù…Ø³ØªÙˆÙ‰.",
        start_btn_prefix: "Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³ØªÙˆÙ‰", reset_btn: "Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† (Ù…Ø³ØªÙˆÙ‰ 1)",
        fail_title: "ÙØ´Ù„", fail_text: "Ù„Ù… ØªØµÙ„ Ù„Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©...", fail_label: "Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:", fail_btn: "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©",
        win_title: "Ù†Ø¬Ø§Ø­!", win_text: "ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙ‰! ØªÙ… Ø§Ù„Ø­ÙØ¸.", win_btn: "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ",
        you: "Ø£Ù†Øª", bot: "Ø¨ÙˆØª", unlocked: "Ù…ÙØªÙˆØ­", locked_prefix: "ÙØªØ­ Ù…."
    },
    id: {
        lb_title: "3 Teratas", buff_msg: "âš¡ï¸ +20% Kec.",
        guide_title: "Koleksi Jarahan", guide_subtitle: "Level Saat Ini:", guide_close: "Tutup",
        start_title: "Fishing Brawl", start_t1: "Selamat datang kembali!", start_t2: "Kesulitan meningkat tiap level.",
        start_btn_prefix: "Mulai Level", reset_btn: "Reset Progres (Lv.1)",
        fail_title: "Gagal", fail_text: "Skor target tidak tercapai...", fail_label: "Skor Akhir:", fail_btn: "Coba Lagi",
        win_title: "Berhasil!", win_text: "Level Selesai! Progres disimpan.", win_btn: "Level Selanjutnya",
        you: "ANDA", bot: "Bot", unlocked: "Terbuka", locked_prefix: "Buka Lv."
    },
    tr: {
        lb_title: "Ä°lk 3", buff_msg: "âš¡ï¸ +%20 HÄ±z",
        guide_title: "Ganimet Koleksiyonu", guide_subtitle: "Mevcut Seviye:", guide_close: "Kapat",
        start_title: "BalÄ±k SavaÅŸÄ±", start_t1: "Tekrar hoÅŸgeldiniz!", start_t2: "Zorluk seviye ile artar.",
        start_btn_prefix: "BaÅŸla: Sv.", reset_btn: "SÄ±fÄ±rla (Sv.1)",
        fail_title: "BaÅŸarÄ±sÄ±z", fail_text: "Hedef puana ulaÅŸÄ±lamadÄ±...", fail_label: "Son Puan:", fail_btn: "Tekrar Dene",
        win_title: "BaÅŸarÄ±lÄ±!", win_text: "Seviye TamamlandÄ±! Kaydedildi.", win_btn: "Sonraki Seviye",
        you: "SEN", bot: "Bot", unlocked: "AÃ§Ä±ldÄ±", locked_prefix: "Kilit Lv."
    }
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let W, H;
function resize() {
    const dpr = window.devicePixelRatio || 1;
    W = window.innerWidth;
    H = window.innerHeight;
    canvas.width = W * dpr;
    canvas.height = H * dpr;
    ctx.scale(dpr, dpr);
}
window.addEventListener('resize', resize);
resize();

// --- 54ç§æˆ˜åˆ©å“æ•°æ® ---
const RAW_LOOT = [
    // Lv.1 (4ä¸ª)
    { emoji: 'ğŸ‘¢', score: 10,   weight: 5.0, speed: 0.5, radius: 24, type: 'trash' },
    { emoji: 'ğŸ¥«', score: 15,   weight: 4.5, speed: 0.4, radius: 20, type: 'trash' },
    { emoji: 'ğŸŸ', score: 200,  weight: 2.0, speed: 1.5, radius: 22, type: 'fish' },
    { emoji: 'ğŸ¡', score: 150,  weight: 3.5, speed: 0.8, radius: 28, type: 'fish' },
    // æ¯2å…³è§£é”
    { emoji: 'ğŸ§±', score: 5,    weight: 8.0, speed: 0.2, radius: 26, type: 'trash' }, 
    { emoji: 'ğŸ¦´', score: 8,    weight: 4.0, speed: 0.5, radius: 18, type: 'trash' }, 
    { emoji: 'ğŸ§¦', score: 5,    weight: 3.0, speed: 0.6, radius: 16, type: 'trash' },
    { emoji: 'ğŸ’©', score: 1,    weight: 6.0, speed: 0.3, radius: 22, type: 'trash' },
    { emoji: 'ğŸ ', score: 400,  weight: 1.5, speed: 2.5, radius: 18, type: 'fish' },
    { emoji: 'ğŸŒ¿', score: 2,    weight: 2.0, speed: 0.5, radius: 20, type: 'trash' },
    { emoji: 'ğŸ¦‘', score: 350,  weight: 1.5, speed: 2.2, radius: 20, type: 'fish' },
    { emoji: 'ğŸ¦€', score: 450,  weight: 4.0, speed: 0.6, radius: 25, type: 'fish' },
    { emoji: 'ğŸ¦', score: 500,  weight: 1.0, speed: 3.0, radius: 14, type: 'fish' },
    { emoji: 'ğŸš', score: 300,  weight: 5.0, speed: 0.1, radius: 15, type: 'fish' },
    { emoji: 'ğŸ¸', score: 600,  weight: 1.2, speed: 2.8, radius: 18, type: 'fish' },
    { emoji: 'ğŸª¼', score: 550,  weight: 2.0, speed: 1.0, radius: 22, type: 'fish' },
    { emoji: 'ğŸ¦†', score: 700,  weight: 2.5, speed: 2.5, radius: 24, type: 'fish' },
    { emoji: 'âš“', score: 100,  weight: 10.0, speed: 0.1, radius: 30, type: 'trash' }, 
    { emoji: 'ğŸ¾', score: 50,   weight: 3.0, speed: 1.0, radius: 15, type: 'trash' },
    { emoji: 'ğŸ¢', score: 1000, weight: 6.0, speed: 0.4, radius: 36, type: 'fish' }, 
    { emoji: 'ğŸ“±', score: 1200, weight: 0.8, speed: 2.5, radius: 15, type: 'rare' },
    { emoji: 'ğŸ¦', score: 1100, weight: 3.5, speed: 1.5, radius: 26, type: 'fish' },
    { emoji: 'ğŸ“·', score: 1500, weight: 1.5, speed: 2.0, radius: 20, type: 'rare' },
    { emoji: 'ğŸ™', score: 1300, weight: 4.0, speed: 1.2, radius: 30, type: 'fish' },
    { emoji: 'âŒš', score: 1800, weight: 0.5, speed: 3.0, radius: 12, type: 'rare' },
    { emoji: 'ğŸ¦ˆ', score: 2000, weight: 5.0, speed: 3.5, radius: 40, type: 'fish' },
    { emoji: 'ğŸ”‘', score: 800,  weight: 0.2, speed: 3.0, radius: 10, type: 'rare' },
    { emoji: 'ğŸ¬', score: 2200, weight: 2.5, speed: 4.0, radius: 32, type: 'fish' },
    { emoji: 'ğŸ’', score: 2500, weight: 0.1, speed: 4.0, radius: 8,  type: 'rare' },
    { emoji: 'ğŸ³', score: 3000, weight: 8.0, speed: 1.0, radius: 50, type: 'fish' },
    { emoji: 'ğŸ‘›', score: 1600, weight: 1.0, speed: 2.0, radius: 18, type: 'rare' },
    { emoji: 'ğŸ’³', score: 1400, weight: 0.1, speed: 3.5, radius: 12, type: 'rare' },
    { emoji: 'ğŸ’»', score: 2000, weight: 3.0, speed: 1.0, radius: 28, type: 'rare' },
    { emoji: 'ğŸš', score: 2800, weight: 2.0, speed: 5.0, radius: 22, type: 'rare' },
    { emoji: 'ğŸ’°', score: 3000, weight: 2.0, speed: 3.0, radius: 20, type: 'legendary' }, 
    { emoji: 'ğŸ“º', score: 2500, weight: 2.5, speed: 1.5, radius: 28, type: 'rare' },
    { emoji: 'ğŸš—', score: 3500, weight: 8.0, speed: 4.0, radius: 35, type: 'legendary' },
    { emoji: 'ğŸ’', score: 4000, weight: 0.5, speed: 4.5, radius: 14, type: 'legendary' },
    { emoji: 'ğŸ‘‘', score: 4500, weight: 1.0, speed: 2.0, radius: 20, type: 'legendary' },
    { emoji: 'ğŸ†', score: 3800, weight: 2.0, speed: 1.0, radius: 25, type: 'legendary' },
    { emoji: 'ğŸš€', score: 5000, weight: 3.0, speed: 8.0, radius: 30, type: 'legendary' },
    { emoji: 'ğŸ›¸', score: 5500, weight: 1.5, speed: 6.0, radius: 25, type: 'legendary' },
    { emoji: 'ğŸŒ¹', score: 6000, weight: 0.1, speed: 5.0, radius: 12, type: 'legendary' },
    { emoji: 'ğŸ‘½', score: 6666, weight: 0.5, speed: 7.0, radius: 16, type: 'legendary' },
    { emoji: 'ğŸ‘»', score: 4444, weight: 0.0, speed: 3.0, radius: 20, type: 'legendary' },
    { emoji: 'ğŸ¤–', score: 5000, weight: 5.0, speed: 2.0, radius: 28, type: 'legendary' },
    { emoji: 'ğŸ«€', score: 8888, weight: 0.3, speed: 6.0, radius: 14, type: 'legendary' },
    { emoji: 'â¤ï¸', score: 7777, weight: 0.2, speed: 4.0, radius: 18, type: 'legendary' },
    { emoji: 'ğŸ—¿', score: 5000, weight: 15.0, speed: 0.1, radius: 40, type: 'legendary' },
    { emoji: 'ğŸ¦–', score: 9000, weight: 10.0, speed: 5.0, radius: 50, type: 'legendary' },
    { emoji: 'ğŸŒš', score: 9500, weight: 8.0, speed: 1.5, radius: 45, type: 'legendary' },
    { emoji: 'ğŸŒŸ', score: 8000, weight: 0.1, speed: 10.0, radius: 15, type: 'legendary' },
    { emoji: 'ğŸŒ', score: 9999, weight: 12.0, speed: 0.5, radius: 60, type: 'legendary' },
    { emoji: 'ğŸ‘‘', score: 10000, weight: 1.0, speed: 5.0, radius: 20, type: 'legendary' },
];

const LOOT_DB = RAW_LOOT.map((item, index) => {
    let lvl = 1;
    if (index >= 4) {
        lvl = 3 + (index - 4) * 2;
    }
    return { ...item, minLevel: lvl };
});

const CONFIG = { baseHookSpeed: 14, swingSpeed: 0.025 };

function getSpawnWeights(level) {
    let weights = { trash: 15, fish: 50, rare: 10, legendary: 1 };
    if (level <= 15) {
        weights.trash = 5 + (level * 0.5); 
        weights.fish = 70 - (level * 0.5); 
        weights.rare = 20; weights.legendary = 5;
    } else if (level <= 50) {
        weights.trash = 15 + ((level - 15) * 1.0); 
        weights.fish = 60 - ((level - 15) * 0.5);  
        weights.rare = 15 - ((level - 15) * 0.2);  
        weights.legendary = 3;
    } else {
        let extra = level - 50;
        weights.trash = 50 + (extra * 0.5); 
        weights.fish = 35 - (extra * 0.3);
        weights.rare = 5; weights.legendary = 1;
    }
    return weights;
}

function getAIDelay(level) { return Math.max(8, 120 - (level * 1.1)); }
function getBotCount(level) { return Math.min(19, 1 + Math.floor(level / 5.5)); }
function getTargetScore(level) {
    if (level <= 15) return 300 + (level * 150); 
    if (level <= 50) return 2500 + ((level-15) * 300); 
    return 13000 + ((level-50) * 400); 
}

const Ocean = {
    offset: 0,
    draw() {
        this.offset += 0.015;
        let grad = ctx.createLinearGradient(0, 0, 0, H);
        grad.addColorStop(0, "#84fab0"); grad.addColorStop(0.4, "#8fd3f4"); grad.addColorStop(1, "#002050");
        ctx.fillStyle = grad; ctx.fillRect(0, 0, W, H);
        this.drawWave(120, 0.008, 10, "rgba(255, 255, 255, 0.15)");
        this.drawWave(180, 0.012, 15, "rgba(255, 255, 255, 0.1)");
        this.drawWave(240, 0.006, 8, "rgba(255, 255, 255, 0.05)");
    },
    drawWave(yBase, freq, amp, color) {
        ctx.fillStyle = color; ctx.beginPath(); ctx.moveTo(0, H);
        for (let i = 0; i <= W; i += 10) {
            let y = yBase + Math.sin(i * freq + this.offset) * amp;
            ctx.lineTo(i, y + i * 0.05); 
        }
        ctx.lineTo(W, H); ctx.lineTo(0, H); ctx.fill();
    }
};

class Angler {
    constructor(id, totalCount, isPlayer) {
        this.id = id; this.isPlayer = isPlayer; this.score = 0; 
        const rowSize = 5; const totalRows = Math.ceil(totalCount / rowSize);
        this.row = Math.floor(id / rowSize); this.col = id % rowSize;
        this.countInThisRow = (this.row === totalRows - 1) ? (totalCount - (this.row * rowSize)) : rowSize;
        this.baseTop = 220; this.rowHeight = 70;
        this.y = this.baseTop + this.row * this.rowHeight; this.x = 0; 
        this.color = this.isPlayer ? '#FFD700' : '#888';
        this.angle = Math.PI/2; this.swingDir = Math.random() > 0.5 ? 1 : -1;
        this.state = 0; this.lineLen = 20; this.maxLen = H * 1.3; this.caughtItem = null;
        this.aiReactionBase = getAIDelay(Game.level); this.resetAI();
    }
    resetAI() { this.aiTimer = this.aiReactionBase + (Math.random() * 20 - 10); }
    update() {
        const maxLayoutWidth = Math.min(W, 600); const offsetLeft = (W - maxLayoutWidth) / 2;
        this.x = offsetLeft + (maxLayoutWidth / (this.countInThisRow + 1)) * (this.col + 1);
        if (this.state === 0) {
            const limit = 0.65;
            if (this.angle > Math.PI - limit) this.swingDir = -1;
            if (this.angle < limit) this.swingDir = 1;
            this.angle += CONFIG.swingSpeed * this.swingDir;
            if (!this.isPlayer) {
                this.aiTimer--;
                if (this.aiTimer <= 0) { this.shoot(); this.resetAI(); }
            }
        } else if (this.state === 1) {
            this.lineLen += CONFIG.baseHookSpeed;
            const tx = this.x + Math.cos(this.angle) * this.lineLen;
            const ty = this.y + Math.sin(this.angle) * this.lineLen;
            if (this.lineLen >= this.maxLen || tx<0 || tx>W) { this.state = 3; this.waitTimer = 10; }
            else {
                for (let item of Game.items) {
                    if (!item.caught && Math.hypot(tx-item.x, ty-item.y) < item.radius + 5) {
                        item.caught = true; this.caughtItem = item; this.state = 2;
                        if(this.isPlayer) {
                            let isHighValue = item.score >= 1000;
                            Game.addEffect(tx, ty, isHighValue ? "Wow!" : "Hit!", isHighValue ? "#FFD700" : "#fff");
                        }
                        break;
                    }
                }
            }
        } else if (this.state === 3) {
            this.waitTimer--; if (this.waitTimer<=0) this.state = 2;
        } else if (this.state === 2) {
            let speedMult = 1.0; if (Game.leaderId === this.id) speedMult = 1.2;
            let speed = (CONFIG.baseHookSpeed * 1.5 * speedMult);
            if (this.caughtItem) speed = (CONFIG.baseHookSpeed / this.caughtItem.weight) * speedMult;
            this.lineLen -= speed;
            if(this.caughtItem) {
                this.caughtItem.x = this.x + Math.cos(this.angle) * this.lineLen;
                this.caughtItem.y = this.y + Math.sin(this.angle) * this.lineLen;
            }
            if (this.lineLen <= 20) {
                this.lineLen = 20; this.state = 0;
                if (this.caughtItem) {
                    this.score += this.caughtItem.score;
                    if (this.isPlayer) {
                        Game.playerScore = this.score;
                        let isLegend = this.caughtItem.type === 'legendary';
                        Game.addEffect(this.x, this.y-50, `+${this.caughtItem.score}`, isLegend ? "#FFD700" : "#fff", isLegend?1.5:1);
                    }
                    Game.items = Game.items.filter(i => i !== this.caughtItem);
                    this.caughtItem = null;
                }
            }
        }
    }
    shoot() { if (this.state === 0) this.state = 1; }
    draw() {
        const tx = this.x + Math.cos(this.angle) * this.lineLen;
        const ty = this.y + Math.sin(this.angle) * this.lineLen;
        ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(tx, ty);
        ctx.strokeStyle = this.isPlayer ? 'rgba(255, 255, 255, 0.95)' : 'rgba(255, 255, 255, 0.4)';
        ctx.lineWidth = this.isPlayer ? 2 : 1; ctx.stroke();
        ctx.beginPath(); ctx.arc(tx, ty, 5, 0, Math.PI*2);
        ctx.fillStyle = this.isPlayer ? '#FF3B30' : '#ccc'; ctx.fill();
        
        let avatarImg = this.isPlayer ? IMAGES.player : IMAGES.bot;
        if (avatarImg.complete) {
            ctx.drawImage(avatarImg, this.x - 25, this.y - 45, 50, 50);
        } else {
            ctx.font = "24px sans-serif";
            ctx.fillText(this.isPlayer?"ğŸ¤ ":"ğŸ¤–", this.x, this.y-22);
        }
        if (Game.leaderId === this.id) { ctx.font = "18px sans-serif"; ctx.fillText("ğŸ‘‘", this.x, this.y - 48); }
        if (this.isPlayer) {
            ctx.fillStyle="#34C759"; ctx.beginPath();
            ctx.moveTo(this.x, this.y-55); ctx.lineTo(this.x-6, this.y-65); ctx.lineTo(this.x+6, this.y-65); ctx.fill();
        }
    }
}

class Item {
    constructor() {
        let availablePool = LOOT_DB.filter(i => Game.level >= i.minLevel);
        const weights = getSpawnWeights(Game.level);
        let weightedPool = availablePool.map(item => {
            let w = 10; 
            if (item.type === 'trash') w = weights.trash;
            if (item.type === 'fish') w = weights.fish;
            if (item.type === 'rare') w = weights.rare;
            if (item.type === 'legendary') w = weights.legendary;
            if (item.minLevel === Game.level) w += 50;
            return { item, weight: w };
        });
        let totalWeight = weightedPool.reduce((sum, wp) => sum + wp.weight, 0);
        let random = Math.random() * totalWeight;
        let selected = weightedPool[0].item;
        for (let wp of weightedPool) {
            if (random < wp.weight) { selected = wp.item; break; }
            random -= wp.weight;
        }
        Object.assign(this, selected);
        this.speed *= (1 + Math.min(0.5, Game.level * 0.01)); 
        const rows = Math.ceil(Game.totalAnglers/5);
        const lastAnglerY = 220 + (rows - 1) * 70; 
        const safeTop = lastAnglerY + 60;
        this.y = safeTop + Math.random() * (H - safeTop - 40);
        this.dir = Math.random() > 0.5 ? 1 : -1;
        this.x = this.dir === 1 ? -60 : W + 60;
        this.caught = false; this.animOffset = Math.random() * 100;
    }
    update() {
        if (!this.caught) this.x += this.speed * this.dir;
        return (this.dir===1 && this.x<W+70) || (this.dir===-1 && this.x>-70);
    }
    draw() {
        ctx.save(); ctx.translate(this.x, this.y);
        if(this.dir===-1 && !this.caught) ctx.scale(-1, 1);
        if(this.caught) ctx.rotate(Math.sin(Game.frameCount*0.3)*0.5);
        const pulse = 10 + Math.sin((Game.frameCount + this.animOffset) * 0.1) * 4;
        ctx.shadowColor = "rgba(255, 255, 255, 1)"; ctx.shadowBlur = pulse; 
        ctx.font = `${this.radius*2.2}px Apple Color Emoji, Segoe UI Emoji`; 
        ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(this.emoji, 0, 0);
        if (this.type === 'legendary' && !this.caught) {
            ctx.shadowColor = "rgba(255, 220, 0, 1)"; ctx.shadowBlur = pulse + 10;
            ctx.globalCompositeOperation = 'source-over'; ctx.fillText(this.emoji, 0, 0); 
        }
        ctx.restore();
    }
}

const Game = {
    level: 1, maxLevel: 1, lang: 'en',
    playerScore: 0, target: 0, timeLeft: 60, totalAnglers: 1, leaderId: -1,
    anglers: [], items: [], effects: [], isPlaying: false, timerId: null, loopId: null, frameCount: 0,

    init() {
        const savedLevel = localStorage.getItem('fishing_max_level');
        if (savedLevel) { this.maxLevel = parseInt(savedLevel); }
        this.updateUIText();
    },

    setLanguage(langCode) {
        this.lang = langCode;
        this.updateUIText();
        const guideList = document.getElementById('guide-list');
        if (langCode === 'ar') guideList.classList.add('rtl-mode');
        else guideList.classList.remove('rtl-mode');
    },

    t(key) { return TRANSLATIONS[this.lang][key] || TRANSLATIONS['en'][key]; },

    updateUIText() {
        const T = this.t.bind(this);
        document.getElementById('ui-lb-title').innerText = T('lb_title');
        document.getElementById('buff-msg').innerText = T('buff_msg');
        document.getElementById('level-display').innerText = this.level > 1 ? this.level : this.maxLevel;
        
        document.getElementById('guide-title').innerText = T('guide_title');
        document.getElementById('guide-subtitle').innerText = T('guide_subtitle');
        document.getElementById('guide-close-btn').innerText = T('guide_close');

        document.getElementById('start-title').innerText = T('start_title');
        document.getElementById('start-text-1').innerText = T('start_t1');
        document.getElementById('start-text-2').innerText = T('start_t2');
        document.getElementById('start-btn').innerText = `${T('start_btn_prefix')} ${this.maxLevel}`;
        document.getElementById('reset-btn').innerText = T('reset_btn');

        document.getElementById('fail-title').innerText = T('fail_title');
        document.getElementById('fail-text').innerText = T('fail_text');
        document.getElementById('fail-score-label').innerText = T('fail_label');
        document.getElementById('fail-btn').innerText = T('fail_btn');

        document.getElementById('win-title').innerText = T('win_title');
        document.getElementById('win-text').innerText = T('win_text');
        document.getElementById('win-btn').innerText = T('win_btn');
    },

    showGuide() {
        document.getElementById('guide-curr-level').innerText = this.maxLevel;
        let html = '';
        LOOT_DB.forEach(item => {
            let className = `t-${item.type}`;
            let unlocked = this.maxLevel >= item.minLevel;
            let lockedClass = unlocked ? 'unlocked' : 'locked';
            let lockText = unlocked ? this.t('unlocked') : `${this.t('locked_prefix')}${item.minLevel}`;
            let emojiDisplay = unlocked ? item.emoji : 'ğŸ”’';
            html += `
                <div class="guide-row">
                    <div class="guide-left">
                        <div class="guide-emoji">${emojiDisplay}</div>
                        <span class="guide-score ${className}">${item.score}</span>
                    </div>
                    <span class="guide-level ${lockedClass}">${lockText}</span>
                </div>
            `;
        });
        document.getElementById('guide-list').innerHTML = html;
        this.showModal('guide-screen');
    },

    closeGuide() {
        if (this.isPlaying) document.getElementById('guide-screen').classList.remove('active');
        else this.showModal('start-screen');
    },

    saveProgress(newLevel) {
        if (newLevel > this.maxLevel) {
            this.maxLevel = newLevel;
            localStorage.setItem('fishing_max_level', this.maxLevel);
        }
    },

    resetProgress() {
        if(confirm('Reset progress?')) {
            localStorage.removeItem('fishing_max_level');
            this.maxLevel = 1; this.updateUIText(); alert('Progress reset.');
        }
    },

    startSavedLevel() { this.startLevel(this.maxLevel); },

    showModal(id) {
        document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
        if(id) document.getElementById(id).classList.add('active');
    },

    startLevel(lvl) {
        this.level = lvl; this.playerScore = 0; this.timeLeft = 60;
        this.target = getTargetScore(lvl);
        let botCount = getBotCount(lvl);
        this.totalAnglers = botCount + 1; 
        this.showModal(null);
        this.updateUIText();
        document.getElementById('level-display').innerText = lvl;
        this.initEntities();
        this.isPlaying = true;
        clearInterval(this.timerId);
        this.timerId = setInterval(() => {
            if(!this.isPlaying) return;
            this.timeLeft--;
            const timeEl = document.getElementById('time');
            timeEl.innerText = this.timeLeft;
            timeEl.style.color = this.timeLeft <= 10 ? '#FF3B30' : '#fff';
            if (this.timeLeft <= 0) this.checkResult();
        }, 1000);
        cancelAnimationFrame(this.loopId);
        this.loop();
    },

    initEntities() {
        this.anglers = []; this.items = []; this.effects = [];
        let playerIdx = Math.floor(this.totalAnglers / 2);
        for (let i = 0; i < this.totalAnglers; i++) {
            this.anglers.push(new Angler(i, this.totalAnglers, i === playerIdx));
        }
        for(let i=0; i<8; i++) this.items.push(new Item());
    },

    updateLeaderboard() {
        if (this.frameCount % 10 === 0) {
            let sorted = [...this.anglers].sort((a,b) => b.score - a.score);
            this.leaderId = sorted[0].id;
            let html = '';
            for(let i=0; i<Math.min(3, sorted.length); i++) {
                let ag = sorted[i];
                let name = ag.isPlayer ? this.t('you') : `${this.t('bot')} ${ag.id}`;
                let rowClass = ag.isPlayer ? "lb-row me" : "lb-row";
                html += `<div class="${rowClass}"><span>${i+1}.${name}</span><span>${ag.score}</span></div>`;
            }
            document.getElementById('lb-list').innerHTML = html;
            const buffEl = document.getElementById('buff-msg');
            if (sorted[0].isPlayer) buffEl.classList.add('active');
            else buffEl.classList.remove('active');
        }
    },

    retryLevel() { this.startLevel(this.level); },
    nextLevel() { this.startLevel(this.level + 1); },

    checkResult() {
        this.isPlaying = false; clearInterval(this.timerId);
        if (this.playerScore >= this.target) {
            this.saveProgress(this.level + 1); this.showModal('win-screen');
        } else {
            document.getElementById('fail-score').innerText = this.playerScore; this.showModal('fail-screen');
        }
    },

    addEffect(x, y, text, color="#fff", scale=1) {
        this.effects.push({x, y, text, color, scale, life: 60});
    },

    loop() {
        if (!this.isPlaying) return;
        ctx.clearRect(0,0,W,H); this.frameCount++;
        Ocean.draw();
        document.getElementById('score').innerText = this.playerScore;
        document.getElementById('target').innerText = this.target;
        this.updateLeaderboard();
        let spawnRate = Math.max(10, 60 - (this.totalAnglers * 1.5)); 
        if (this.frameCount % Math.floor(spawnRate) === 0) {
            if (this.items.length < 30) this.items.push(new Item());
        }
        this.items = this.items.filter(i => { if (i.caught) return true; return i.update(); });
        this.anglers.forEach(a => a.update());
        let sortedAnglers = [...this.anglers].sort((a,b) => a.y - b.y);
        sortedAnglers.forEach(a => { a.draw(); });
        this.items.forEach(i => { if(!i.caught) i.draw(); });
        sortedAnglers.forEach(a => { if(a.caughtItem) a.caughtItem.draw(); });
        this.effects = this.effects.filter(e => e.life>0);
        this.effects.forEach(e => {
            e.y -= 1.0; e.life--;
            ctx.save(); ctx.translate(e.x, e.y);
            let s = e.scale * (1 + Math.sin(e.life * 0.2) * 0.1);
            ctx.scale(s, s); ctx.fillStyle = e.color; ctx.globalAlpha = Math.min(1, e.life/30);
            ctx.font = "800 24px var(--font-stack)"; ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 4;
            ctx.fillText(e.text, 0, 0); ctx.restore();
        });
        this.loopId = requestAnimationFrame(() => this.loop());
    }
};

Game.init();

function handleInput(e) {
    if (!Game.isPlaying) return;
    if (e.target.closest('.glass-pill') || e.target.tagName === 'BUTTON' || e.target.tagName === 'SELECT') return;
    e.preventDefault();
    const player = Game.anglers.find(a => a.isPlayer);
    if (player) player.shoot();
}
canvas.addEventListener('pointerdown', handleInput);

</script>
</body>
</html>
